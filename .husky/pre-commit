#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

set -e

# Run a frozen install when the frontend package manifest changes to verify the lockfile stays in sync,
# but only if dependencies or devDependencies actually changed.
if git diff --cached --name-only | grep -Eq '^frontend/package\.json$'; then
  if ! command -v jq >/dev/null 2>&1; then
    echo "Error: jq is required for this pre-commit hook to check dependency changes." >&2
    exit 1
  fi
  # Extract staged dependencies/devDependencies once for downstream comparisons
  STAGED_DEPS=$(git show :frontend/package.json | jq -c '{dependencies,devDependencies}')
  NEED_INSTALL=false

  if git cat-file -e HEAD:frontend/package.json 2>/dev/null; then
    HEAD_DEPS=$(git show HEAD:frontend/package.json | jq -c '{dependencies,devDependencies}')
    if [ "$STAGED_DEPS" != "$HEAD_DEPS" ]; then
      NEED_INSTALL=true
    fi
  else
    # If the file is new, only run install if there are any dependencies or devDependencies
    HAS_DEPS=$(printf '%s' "$STAGED_DEPS" | jq '((.dependencies // {}) | length) + ((.devDependencies // {}) | length)')
    if [ "$HAS_DEPS" -gt 0 ]; then
      NEED_INSTALL=true
    fi
  fi

  if [ "$NEED_INSTALL" = true ]; then
    echo "Verifying frontend lockfile is up to date..."
    pnpm --dir frontend install --frozen-lockfile --ignore-scripts --prefer-offline
  fi
fi
